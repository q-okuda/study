<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>svg-animation</title>
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    body {
      width: 100vw;
    }

    img {
      width: 100%;
      height: auto;
      vertical-align: bottom;
    }

    .contents {
      width: 100%;
      overflow: hidden;
    }

    .section {
      height: 100vh;
      background-image: repeating-linear-gradient(0deg, transparent, transparent 50px, rgb(252, 169, 169) 50px, rgb(252, 169, 169) 100px);
    }

    .eyesSection {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    .eyesWrap {
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      width: 50%;
      max-width: 500px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .eyeOuter {
      width: 45%;
      aspect-ratio: 1 / 1.1;
      border: 2px solid #000;
      border-radius: 100%;
      position: relative;
      overflow: hidden;
    }

    .eye {
      width: 35%;
      aspect-ratio: 1 / 1.1;
      border-radius: 100%;
      background-color: #000;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: transform 0.1s, width 0.2s;
    }

    .add-lookBubble .eye {
      transition: transform 0.7s, width 0.2s;
    }

    .bubble {
      width: 25%;
      padding-top: 15%;
      border: 1px solid #aaa;
      border-radius: 100%;
      position: absolute;
      opacity: 0;
      visibility: hidden;
      transform: scale(0);
      transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
    }

    .bubble.add-show {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .bubble1 {
      top: 8%;
      left: 8%;
    }

    .bubble2 {
      top: 8%;
      right: 20%;
    }

    .bubble3 {
      bottom: 8%;
      left: 15%;
    }

    .bubble4 {
      bottom: 15%;
      right: 16%;
    }

    .bubble5 {
      top: 31%;
      left: 1%;
    }

    .bubble6 {
      bottom: 32%;
      right: 1%;
    }

    .bubble>.bubble_child1 {
      width: 25%;
      padding-top: 10%;
      background-color: #fff;
      border: 1px solid #aaa;
      border-radius: 100%;
      position: absolute;
      top: 103%;
      left: 56%;
    }

    .bubble>.bubble_child2 {
      width: 5%;
      padding-top: 5%;
      background-color: #fff;
      border: 1px solid #aaa;
      border-radius: 100%;
      position: absolute;
      top: 123%;
      left: 74%;
    }

    .toggleBtn {
      padding: 0 5px;
      position: absolute;
      bottom: 1%;
      right: 1%;
    }

    .txtSection {
      width: 100%;
      position: relative;
    }

    .txt {
      /* display: flex; */
      /* flex-direction: column; */
      /* justify-content: center; */
      /* align-items: center; */
      margin: 0 auto;
      writing-mode: vertical-rl;
      z-index: 1;
      text-shadow: 0px 0px 3px #fff;
      white-space: nowrap;
    }

    .txt>span {
      display: inline-block;
      font-size: 2.7vh;
    }

    .txt>.mod-img {
      position: relative;
      width: 100%;
      height: 22vh;
    }

    .mod-img>img {
      width: auto;
      height: 100%;
      position: absolute;
      left: 50%;
      transform: translate(-31%, 0);
    }

    .pc {
      height: 45vh;
      aspect-ratio: 1842 / 1572;
      position: fixed;
      bottom: 0;
      left: 50%;
      transform-origin: 50% 56%;
    }

    @media screen and (max-width: 768px) {
      .pc {
        width: 70vw;
        height: auto;
      }
    }

    .pcBottom {
      height: 45vh;
      aspect-ratio: 1842 / 1572;
      position: fixed;
      bottom: 0;
      left: 50%;
      transform-origin: 50% 56%;
      z-index: 2;
    }

    @media screen and (max-width: 768px) {
      .pcBottom {
        width: 70vw;
        height: auto;
      }
    }

    .pcBottom>img {
      position: absolute;
      bottom: 0;
      z-index: 1;
    }

    .svgSection {
      width: 100%;
      /* height: 100%; */
    }

    .svgWrap {
      width: 150%;
    }

    .cls-1 {
      fill: none;
      stroke: #ff0000;
      stroke-miterlimit: 10;
      stroke-width: 5px;
    }

    .circle1 {
      transform: translate(189px, 92px);
      fill: #ff0000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .circle2 {
      transform: translate(623px, 73px);
      fill: #ff0000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .circle3 {
      transform: translate(1180px, 0px);
      fill: #ff0000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .dot {
      fill: #000000;
    }

    .morphingSection {
      padding-top: 100px;
    }

    .glassesWrap {
      display: flex;
      justify-content: space-between;
      width: 50%;
      position: relative;
      margin: 0 auto;
    }

    .glass {
      width: 46%;
      transform: rotate(0deg);
      transform-origin: 50% 42%;
      position: relative;
      z-index: 2;
    }

    .glassPath {
      fill:#283233;
    }

    .nosePad {
      width: 17.7%;
      top: 37.5%;
      left: 50.2%;
      transform: translateX(-50%);
      position: absolute;
      z-index: 1;
    }

    .nosePadPath {
      fill:#283233;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/MotionPathPlugin.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
</head>

<body>
  <main class="contents">
    <div class="morphingSection">
      <div class="glassesWrap">
        <svg class="glass js-glass" viewBox="0 0 184 207.26">
          <path id="glassPath_1" class="glassPath" d="m152,88.5c0,33.41-26.86,60.5-60,60.5s-60-27.09-60-60.5,26.86-60.5,60-60.5,60,27.09,60,60.5ZM0,88.5c0,36.38,22.81,67.63,55.43,81.23,10.32,12.3,46.58,50.13,89.57,33.27,3.12-1.49,19.13-8.93,18-18-1-8-11-14-17-10-6,5-16.28,7.96-23,8-7.41.04-12.67-3.37-17-7,45.21-5.6,78-42.49,78-87.5C184,39.62,142.81,0,92,0,61.38,0,34.25,14.39,17.53,36.52,6.5,51.12,0,69.08,0,88.5Z" />
        </svg>
        <svg class="nosePad" viewBox="0 0 70.53 32.89">
          <path class="nosePadPath" d="m68.74,24c-20,20-15.6,0-33,0s-15,19-34,0C-6.86,15.41,18.34,0,35.74,0s41.59,15.41,33,24Z"/>
        </svg>
        <svg class="glass js-glass" viewBox="0 0 184 207.26">
          <path id="glassPath_2" class="glassPath" d="m152,88.5c0,33.41-26.86,60.5-60,60.5s-60-27.09-60-60.5,26.86-60.5,60-60.5,60,27.09,60,60.5ZM0,88.5c0,36.38,22.81,67.63,55.43,81.23,10.32,12.3,46.58,50.13,89.57,33.27,3.12-1.49,19.13-8.93,18-18-1-8-11-14-17-10-6,5-16.28,7.96-23,8-7.41.04-12.67-3.37-17-7,45.21-5.6,78-42.49,78-87.5C184,39.62,142.81,0,92,0,61.38,0,34.25,14.39,17.53,36.52,6.5,51.12,0,69.08,0,88.5Z"/>
        </svg>
      </div>
    </div>
    <div id="js-eyesSection" class="eyesSection">
      <div id="js-eyesWrap" class="eyesWrap">
        <div class="eyeOuter left">
          <div id="js-leftEye" class="eye"></div>
        </div>
        <div class="eyeOuter right">
          <div id="js-rightEye" class="eye"></div>
        </div>
      </div>
      <div class="bubble bubble1 js-bubble">
        <div class="bubble_child1"></div>
        <div class="bubble_child2"></div>
      </div>
      <div class="bubble bubble2 js-bubble">
        <div class="bubble_child1"></div>
        <div class="bubble_child2"></div>
      </div>
      <div class="bubble bubble3 js-bubble">
        <div class="bubble_child1"></div>
        <div class="bubble_child2"></div>
      </div>
      <div class="bubble bubble4 js-bubble">
        <div class="bubble_child1"></div>
        <div class="bubble_child2"></div>
      </div>
      <div class="bubble bubble5 js-bubble">
        <div class="bubble_child1"></div>
        <div class="bubble_child2"></div>
      </div>
      <div class="bubble bubble6 js-bubble">
        <div class="bubble_child1"></div>
        <div class="bubble_child2"></div>
      </div>
      <button type="button" id="js-toggleBtn" class="toggleBtn">切り替え</button>
    </div>
    <div class="section"></div>
    <div id="js-txtSection" class="txtSection">
      <p id="js-txt" class="txt">
        <span class="js-letter">あ</span>
        <span class="js-letter">な</span>
        <span class="js-letter">た</span>
        <span class="js-letter">の</span>
        <span class="js-letter mod-img">
          <img src="./txt1.png" alt="">
        </span>
        <span class="js-letter">お</span>
        <span class="js-letter">悩</span>
        <span class="js-letter">み</span>
        <span class="js-letter">解</span>
        <span class="js-letter">決</span>
        <span class="js-letter">で</span>
        <span class="js-letter">き</span>
        <span class="js-letter">る</span>
        <span class="js-letter">か</span>
        <span class="js-letter">も</span>
        <span class="js-letter">し</span>
        <span class="js-letter">れ</span>
        <span class="js-letter">ま</span>
        <span class="js-letter">せ</span>
        <span class="js-letter">ん</span>
        <span class="js-letter">。</span>
      </p>
      <figure id="js-pc" class="pc">
        <img src="./pc.png" alt="">
      </figure>
      <figure id="js-pcBottom" class="pcBottom">
        <img src="./pcBottom.png" alt="">
      </figure>
    </div>
    <div class="section"></div>
    <div id="js-svgSection" class="svgSection">
      <div class="svgWrap" id="js-svgWrap">
        <svg class="svg" viewBox="0 0 1832.52 367.44">
          <path id="js-line" class="cls-1"
                d="m1.15,247.07c23.06,16.18,59.15,38.3,107,55,50.85,17.75,163.77,57.17,251,1,49.7-32,104.98-104,81-158-23.47-52.85-111.4-62.7-169-43-28.77,9.84-80.58,37.53-82,78-.28,8,1.27,56.21,56.5,97.5,56.36,42.13,118.88,40.75,197.5,52.5,78.35,11.71,170.97,25.55,286-6,73.57-20.18,179.84-49.33,188-114,7.2-57.04-63.16-131.94-144-135-73.16-2.77-147.75,53.57-148,105-.4,84.6,200.37,157.51,336,178,194.65,29.41,330.35-37.79,356-51,64.87-33.43,173.35-89.32,168-170-5.16-77.82-114.71-155.93-200-130-60.54,18.4-111.4,89.99-102,152,20.21,133.23,318.16,219.01,553,204,40.14-2.57,73.25-7.74,96-12" />
          <path id="js-circle1" class="circle1"
                d="m251.02,52.4C227.56-.45,139.62-10.3,82.02,9.4,53.25,19.25,1.44,46.94.02,87.4c-.28,8,1.27,56.21,56.5,97.5,28.32,21.17,58.21,31.36,90.9,37.74,7.68-3.45,15.23-7.5,22.6-12.24,49.7-32,104.98-104,81-158Z" />
          <path id="js-circle2" class="circle2"
                d="m294,137.1C301.2,80.06,230.84,5.16,150,2.1,76.84-.67,2.25,55.67,2,107.1c-.24,50,69.8,95.91,155.12,129.34,63.91-19.83,130.49-48.69,136.88-99.34Z" />
          <path id="js-circle3" class="circle3"
                d="m305.13,137.07C299.97,59.25,190.41-18.86,105.13,7.07,44.59,25.47-6.28,97.06,3.13,159.07c8.57,56.53,67.15,104.51,149.69,139.88,65.21-34.06,157.25-87.41,152.31-161.88Z" />
          <circle id="js-dot" class="dot" cx="10" cy="10" r="10"></circle>
        </svg>
      </div>
    </div>
    <div class="section"></div>

  </main>
  <script>
    ((d, w) => {
      w.addEventListener('load', () => {
        let windowWidth = innerWidth;
        let windowHeight = innerHeight;

        const pc = 768;
        const pcMax = 1400;

        // モーフィング
        const glassSvgs = [].slice.call(d.querySelectorAll('.js-glass'));
        const glassPaths = [].slice.call(d.querySelectorAll('.glassPath'));
        const beforeGlassPath1 = Snap('#glassPath_1');
        const beforeGlassPath2 = Snap('#glassPath_2');
        const afterGlassPath = "m152,88.5c0,33.41-26.86,60.5-60,60.5s-60-27.09-60-60.5,26.86-60.5,60-60.5,60,27.09,60,60.5ZM0,88.5c0,36.38,22.81,67.63,55.43,81.23,13.57,4.27,30.95,8.24,50.57,6.27,3-1,54.96-8.79,63-47,4-19-18-6-24-2-6,5-28.28,22.96-35,23-7.41.04-4,26-4,26,45.21-5.6,78-42.49,78-87.5C184,39.62,142.81,0,92,0,61.38,0,34.25,14.39,17.53,36.52,6.5,51.12,0,69.08,0,88.5Z";
        const duration = 2000;
        const deg = 360 * 2;

        beforeGlassPath1.animate({d: afterGlassPath}, duration * 0.7);
        beforeGlassPath2.animate({d: afterGlassPath}, duration * 0.7);
        glassSvgs.forEach((glassSvg)=>{
          glassSvg.style.transition = `transform ${duration}ms`;
          glassSvg.style.transform = `rotate(${deg}deg)`;
        });
        glassPaths.forEach((glassPath)=>{
          glassPath.style.transition = `fill ${duration}ms`;
          glassPath.style.fill = '#d7000f';
        });

        // 切り替え
        const toggleBtn = d.getElementById('js-toggleBtn');
        toggleBtn.addEventListener('click', () => {
          eyesSection.classList.toggle('add-lookBubble');
        });

        // 吹き出しアニメーション
        let bubblePos = { x: 0, y: 0 };
        const changeBubbleVisible = (el) => {
          let index = 0;
          setInterval(() => {
            el[index].classList.remove('add-show');
            index++;
            if (index > el.length - 1) index = 0;
            el[index].classList.add('add-show');
            bubblePos = {
              x: el[index].getBoundingClientRect().left + el[index].offsetWidth / 2,
              y: el[index].getBoundingClientRect().top + el[index].offsetHeight / 2,
            };
            if (eyesSection.classList.contains('add-lookBubble')) {
              calcEyePos();
            }
          }, 2000);
        };

        const bubbles = [].slice.call(d.querySelectorAll('.js-bubble'));
        changeBubbleVisible(bubbles);

        // 目アニメーション
        const eyesSection = d.getElementById('js-eyesSection');
        const eyesWrap = d.getElementById('js-eyesWrap');
        const leftEye = d.getElementById('js-leftEye');
        const rightEye = d.getElementById('js-rightEye');

        const abs = amount => {
          return amount < 0 ? -amount : amount;
        };

        let x;
        let y;
        let eyePosX;
        let eyePosY;

        const calcEyePos = (e) => {
          let mouse;
          if (eyesSection.classList.contains('add-lookBubble')) {
            mouse = {
              x: bubblePos.x,
              y: bubblePos.y,
            };
          } else {
            mouse = {
              x: e.pageX,
              y: e.pageY,
            };
          }
          const eyesCenter = {
            x: eyesWrap.getBoundingClientRect().left + eyesWrap.offsetWidth / 2,
            y: eyesWrap.getBoundingClientRect().top + eyesWrap.offsetHeight / 2,
          };
          x = Math.floor((eyesCenter.x - mouse.x) / eyesWrap.offsetWidth * 100);
          y = Math.floor((eyesCenter.y - mouse.y) / eyesWrap.offsetHeight * 100);

          const eyeWidth = leftEye.offsetWidth;
          const eyeHeight = leftEye.offsetHeight;

          const radian = Math.atan2(y, x);
          const ratioX = eyeWidth * (x / eyeWidth);
          const ratioY = eyeHeight * (y / eyeHeight);
          const maxX = eyeWidth * Math.cos(radian);
          const maxY = eyeHeight * Math.sin(radian);
          eyePosX = abs(maxX) >= abs(ratioX) ? ratioX : maxX;
          eyePosY = abs(maxY) >= abs(ratioY) ? ratioY : maxY;
        };

        w.addEventListener('mousemove', (e) => {
          if (eyesSection.classList.contains('add-lookBubble')) {
            return false;
          }
          calcEyePos(e);
        });


        (function updateEyesPos() {
          leftEye.style.transform = `translate(calc(-50% - ${eyePosX}px), calc(-50% - ${eyePosY}px))`;
          rightEye.style.transform = `translate(calc(-50% - ${eyePosX}px), calc(-50% - ${eyePosY}px))`;
          requestAnimationFrame(updateEyesPos);
        }
        )();

        w.addEventListener('resize', () => {
          leftEye.style.transform = `translate(calc(-50% - ${eyePosX}px), calc(-50% - ${eyePosY}px))`;
          rightEye.style.transform = `translate(calc(-50% - ${eyePosX}px), calc(-50% - ${eyePosY}px))`;
        });

        w.addEventListener('mousedown', () => {
          leftEye.style.width = '38%';
          rightEye.style.width = '38%';
        });

        w.addEventListener('mouseup', () => {
          leftEye.style.width = '35%';
          rightEye.style.width = '35%';
        });

        // テキストアニメーション
        const txtSection = d.getElementById('js-txtSection');
        const txt = d.getElementById('js-txt');
        const pcFig = d.getElementById('js-pc');
        const letter = d.querySelectorAll('.js-letter');
        const inhaleEnd = windowHeight * 2;
        const inhaleTxt = gsap.timeline({
          scrollTrigger: {
            trigger: txt,
            start: 'center center', // 'trigger, browser'
            end: '+=' + inhaleEnd, //アニメーション開始位置から2000px固定する
            scrub: true, //スクロール量に合わせてアニメーションが進む（数字も指定できる）
            pin: true, //トリガー要素を固定する
            // markers: true,
          }
        });

        const fig = '#js-pc, #js-pcBottom';
        gsap.set(fig, { xPercent: -50, yPercent: 100 });
        inhaleTxt
          .to(fig, {
            yPercent: 0,
            duration: 4,
          })
          .to(txt, {
            y: () => { return -pcFig.offsetHeight; },
            duration: 4,
          }, '<')
          .to(txt, {
            yPercent: 20,
            duration: 3,
          })
          .to(letter, {
            y: () => { return windowHeight * 0.5; },
            opacity: 0.5,
            rotate: 90,
            scale: 0,
            duration: 4,
            ease: "power3.in",
            stagger: {
              from: "end",
              each: 1 / letter.length * 2.5,
            }
          }, '<')
          .to(fig, {
            scale: () => { return windowHeight / pcFig.offsetHeight + 2.5; },
            duration: 3,
          })
          .to(fig, {
            opacity: 0
          });


        // 線引くアニメーション
        const svgSection = d.getElementById('js-svgSection');
        const svgWrap = d.getElementById('js-svgWrap');

        const line = d.getElementById('js-line');
        const lineLength = line.getTotalLength();
        line.style.strokeDasharray = lineLength + 'px';
        line.style.strokeDashoffset = lineLength + 'px';

        const circle1 = d.getElementById('js-circle1');
        const circle2 = d.getElementById('js-circle2');
        const circle3 = d.getElementById('js-circle3');

        const dot = d.getElementById('js-dot');

        let svgWrapWidth = svgWrap.offsetWidth;
        let svgHiddenWidth = svgWrapWidth - windowWidth;

        const drawEnd = '2000px';
        // const scrollX = gsap.to(svgSection, {
        //   duration: 0.5,
        //   xPercent: () => svgHiddenWidth / svgWrapWidth * -100,
        //   ease: "power1.inOut",
        //   paused: true,
        // });
        const drawLine = gsap.timeline({
          scrollTrigger: {
            trigger: svgSection,
            start: 'center center', // 'trigger, browser'
            end: '+=' + drawEnd, //アニメーション開始位置から2000px固定する
            scrub: true, //スクロール量に合わせてアニメーションが進む（数字も指定できる）
            pin: true, //トリガー要素を固定する
            // markers: true,
            onUpdate: (self) => {
              const progress = self.progress;
              // console.log(progress);
              if (progress >= 0.115) {
                circle1.style.opacity = '1';
              } else {
                circle1.style.opacity = '0';
              }

              if (progress >= 0.273) {
                circle2.style.opacity = '1';
              } else {
                circle2.style.opacity = '0';
              }

              if (progress >= 0.553) {
                circle3.style.opacity = '1';
              } else {
                circle3.style.opacity = '0';
              }

              // if (progress >= 0.38) {
              //   scrollX.play();
              // } else {
              //   scrollX.reverse();
              // }
            }
          }
        });


        drawLine
          .to(line, {
            strokeDashoffset: 0,
          })
          .to(dot, {
            motionPath: {
              path: line,
              align: line,
              alignOrigin: [0.5, 0.5]
            }
          }, 0)
          .to(svgWrap, {
            xPercent: svgHiddenWidth / svgWrapWidth * -100,
          }, 0.11);
      });
    })(document, window);
  </script>
</body>

</html>